# 实施计划

- [ ] 1. 创建数据模型和数据库结构
  - [ ] 1.1 扩展用户模型添加订阅和积分字段
    - 在 `apps/cms/src/extensions/users-permissions/content-types/user/schema.json` 中添加订阅相关字段
    - 实现用户模型的生命周期钩子以初始化默认值
    - 编写数据库迁移脚本
    - _需求: 1.1, 2.1, 3.1_
  - [ ] 1.2 创建订阅计划内容类型
    - 创建 `api::subscription-plan.subscription-plan` 内容类型
    - 定义字段结构和验证规则
    - 创建种子数据脚本用于初始化订阅计划
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [ ] 1.3 创建积分包内容类型
    - 创建 `api::credit-package.credit-package` 内容类型
    - 定义字段结构和验证规则
    - 创建种子数据脚本用于初始化积分包
    - _需求: 5.1, 5.2, 5.3_
  - [ ] 1.4 创建交易记录内容类型
    - 创建 `api::transaction.transaction` 内容类型
    - 定义字段结构包括类型、状态、金额等
    - 实现自动时间戳和状态管理
    - _需求: 3.6, 5.5, 6.3, 6.4_
  - [ ] 1.5 创建用户配额内容类型
    - 创建 `api::user-quota.user-quota` 内容类型
    - 实现日期和用户的唯一约束
    - 创建索引优化查询性能
    - _需求: 1.2, 1.3, 7.1, 7.2_

- [ ] 2. 实现核心服务层
  - [ ] 2.1 实现订阅管理服务
    - 创建 `api::subscription.subscription` 服务
    - 实现创建、更新、取消订阅的核心逻辑
    - 实现订阅状态检查和自动过期处理
    - 编写单元测试覆盖所有订阅状态转换
    - _需求: 2.1, 2.4, 2.5, 2.6, 4.6_
  - [ ] 2.2 实现积分管理服务
    - 创建 `api::credit.credit` 服务
    - 实现积分充值、消费、查询功能
    - 实现事务性积分操作确保数据一致性
    - 编写单元测试验证积分计算逻辑
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  - [ ] 2.3 实现配额控制服务
    - 创建 `api::quota.quota` 服务
    - 实现配额检查、消费、重置逻辑
    - 集成 Redis 缓存提高性能
    - 编写单元测试验证配额计算和重置逻辑
    - _需求: 1.2, 1.3, 1.5, 7.1, 7.2, 7.4_
  - [ ] 2.4 实现每月积分赠送服务
    - 创建定时任务服务处理每月积分赠送
    - 实现免费用户和会员的不同赠送逻辑
    - 记录积分赠送交易历史
    - 编写测试验证赠送逻辑和时间计算
    - _需求: 1.4, 2.4_

- [ ] 3. 实现 API 控制器和路由
  - [ ] 3.1 实现订阅管理 API
    - 创建订阅控制器处理创建、查询、取消请求
    - 实现参数验证和错误处理
    - 添加认证中间件确保用户只能管理自己的订阅
    - 编写 API 集成测试
    - _需求: 2.1, 2.5, 2.6, 4.1_
  - [ ] 3.2 实现积分管理 API
    - 创建积分控制器处理查询、购买、使用请求
    - 实现积分使用的用途验证
    - 添加事务处理确保操作原子性
    - 编写 API 集成测试
    - _需求: 3.1, 3.2, 3.3, 3.4, 5.1, 5.2, 5.3_
  - [ ] 3.3 实现配额查询 API
    - 创建配额控制器提供使用情况查询
    - 实现实时配额检查接口
    - 优化查询性能使用缓存
    - 编写 API 集成测试
    - _需求: 1.2, 1.3, 1.5, 7.3_
  - [ ] 3.4 实现管理后台 API
    - 创建管理接口用于配置免费用户限额
    - 实现订阅计划和积分包的 CRUD 操作
    - 添加管理员权限验证
    - 编写管理 API 测试
    - _需求: 7.1, 7.2, 7.3, 7.5_

- [ ] 4. 集成支付网关
  - [ ] 4.1 集成 Stripe 支付
    - 创建 Stripe 支付服务封装 SDK
    - 实现支付意图创建和确认流程
    - 实现 Webhook 处理支付状态更新
    - 编写支付流程集成测试
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [ ] 4.2 集成支付宝/微信支付
    - 创建统一的支付接口适配不同支付方式
    - 实现支付回调处理和状态同步
    - 添加支付安全验证（签名校验）
    - 编写多支付渠道集成测试
    - _需求: 6.1, 6.2, 6.3, 6.4_
  - [ ] 4.3 实现退款功能
    - 创建退款服务处理退款请求
    - 实现退款审批流程
    - 更新订阅和积分状态
    - 编写退款流程测试
    - _需求: 6.6_

- [ ] 5. 实现缓存和性能优化
  - [ ] 5.1 实现 Redis 缓存层
    - 创建缓存服务封装 Redis 操作
    - 实现用户订阅状态缓存
    - 实现积分余额缓存
    - 编写缓存一致性测试
    - _需求: 2.3, 3.1, 7.4_
  - [ ] 5.2 实现配额缓存机制
    - 创建配额缓存服务
    - 实现高效的配额检查和更新
    - 添加缓存预热和失效策略
    - 编写性能测试验证缓存效果
    - _需求: 1.2, 1.3, 7.4_
  - [ ] 5.3 优化数据库查询
    - 添加必要的数据库索引
    - 优化高频查询使用预编译语句
    - 实现查询结果分页
    - 执行查询性能测试
    - _需求: 5.5, 7.3_

- [ ] 6. 实现定时任务和后台处理
  - [ ] 6.1 实现订阅续费任务
    - 创建定时任务检查即将到期的订阅
    - 实现自动续费逻辑
    - 处理续费失败的降级流程
    - 编写续费任务测试
    - _需求: 2.5, 2.6, 4.6_
  - [ ] 6.2 实现每日配额重置任务
    - 创建定时任务每日重置用户配额
    - 优化批量更新性能
    - 添加任务执行监控
    - 编写配额重置测试
    - _需求: 1.2, 1.3_
  - [ ] 6.3 实现积分过期处理任务
    - 创建定时任务处理过期积分
    - 实现积分过期通知
    - 记录积分过期日志
    - 编写积分过期测试
    - _需求: 3.1_

- [ ] 7. 实现通知和日志
  - [ ] 7.1 集成通知服务
    - 扩展现有飞书通知服务
    - 实现订阅相关通知模板
    - 添加邮件通知备选方案
    - 编写通知发送测试
    - _需求: 2.4, 4.6, 6.4_
  - [ ] 7.2 实现审计日志
    - 创建审计日志服务
    - 记录所有支付和权限变更
    - 实现日志查询接口
    - 编写日志记录测试
    - _需求: 6.4, 7.5, 7.6_
  - [ ] 7.3 实现监控指标
    - 添加订阅转化率指标
    - 添加支付成功率指标
    - 集成到现有监控系统
    - 创建监控告警规则
    - _需求: 7.6_

- [ ] 8. 实现权限和安全控制
  - [ ] 8.1 实现基于订阅的内容访问控制
    - 创建订阅权限中间件
    - 修改现有内容 API 添加订阅检查
    - 实现优雅的权限不足处理
    - 编写权限控制测试
    - _需求: 1.5, 2.2, 2.3, 7.4_
  - [ ] 8.2 实现积分功能权限控制
    - 创建积分权限验证服务
    - 在音色克隆和音频生成 API 中集成
    - 添加积分不足的友好提示
    - 编写积分权限测试
    - _需求: 3.2, 3.3, 3.4, 3.5_
  - [ ] 8.3 实现 API 限流和防护
    - 添加支付 API 限流保护
    - 实现防重复支付机制
    - 添加异常行为检测
    - 编写安全防护测试
    - _需求: 6.5, 7.6_

- [ ] 9. 数据迁移和兼容性处理
  - [ ] 9.1 创建数据迁移脚本
    - 编写现有用户数据迁移脚本
    - 设置默认订阅状态和积分
    - 处理历史数据兼容性
    - 测试迁移脚本正确性
    - _需求: 1.1, 3.1_
  - [ ] 9.2 实现版本兼容性处理
    - 添加 API 版本控制
    - 实现向后兼容的数据结构
    - 创建弃用功能的过渡方案
    - 编写兼容性测试
    - _需求: 7.3_
